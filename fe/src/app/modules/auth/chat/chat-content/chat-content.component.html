<div class="flex flex-col flex-1 min-w-0 p-5 bg-gray-50">
    <!-- Chat Header -->
    <div
        class="relative flex flex-col flex-shrink-0 h-full shadow-2xl rounded-2xl"
    >
        <div
            class="p-4 bg-[#1255FB] border-b border-gray-100 shadow-sm md:p-6 rounded-t-2xl"
        >
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <ng-container *ngIf="chatService.isMobile">
                        <div
                            class="text-white cursor-pointer material-icons"
                            (click)="clickChevronLeft()"
                        >
                            chevron_left
                        </div>
                    </ng-container>
                    <div>
                        <h2 class="text-xl font-bold text-white">
                            {{ user?.role === 3
                            ? (state?.inforAdmin?.[0]?.fullName || adminData?.username)
                            : (state?.inforUser?.fullName || state?.inforUser?.username || '') }}
                        </h2>
                    </div>
                </div>
            </div>
        </div>

        <div
            #chatContainer
            (scroll)="onScroll()"
            class="relative flex-1 min-h-0 overflow-y-auto bg-[#F7F7F7] overscroll-contain"
        >
            <ng-container *ngIf="isLoadingChat === true">
                <div
                    class="fixed z-50 -translate-x-1/2 top-1/2 left-1/2"
                    [ngClass]="{
                        'left-2/3':
                            user.role === 1 && chatService.isMobile !== true,
                        ' left-1/2':
                            user.role === 3 ||
                            (user.role === 1 && chatService.isMobile === true)
                    }"
                >
                    <div class="loader"></div>
                </div>
            </ng-container>
            <ng-container
                *ngIf="
                    (!chats || chats.length === 0) &&
                    isLoadingChat === false &&
                    isSending === false
                "
            >
                <div class="absolute z-50 -translate-x-1/3 top-[15%] left-1/2">
                    <img
                        src="assets/images/chatbot/none_user.png"
                        class="object-contain w-[78%]"
                    />
                </div>
            </ng-container>
            <div class="p-3 space-y-4 md:p-6 h-96">
                <ng-container *ngFor="let item of chats; let i = index">
                    <div
                        *ngIf="
                            (chats[i - 1] &&
                                compareDates(
                                    formatTimestamp(chats[i - 1].timestamp)[0],
                                    formatTimestamp(chats[i].timestamp)[0]
                                ) !== 0) ||
                            i === 0
                        "
                        class="flex justify-center w-full text-[#A0A0A0] text-xl font-normal font-lexend_deca"
                    >
                        {{
                            formatTimestamp(chats[i].timestamp)[0] +
                                " " +
                                translocoService.translate("chat.at") +
                                " " +
                                formatTimestamp(chats[i].timestamp)[1]
                        }}
                    </div>
                    <div
                        class="flex items-start space-x-3 animate-fade-in"
                        [ngClass]="{
                            'justify-end': item.position === 'right',
                            'justify-start': item.position === 'left'
                        }"
                    >
                        <div class="max-w-[70%]">
                            <app-chat-bubble
                                [config]="item"
                                [user]="user"
                                [inforUser]="state?.inforUser || null"
                                [inforAdmin]="state?.inforAdmin || adminData"
                                (loadImage)="scrollToBottom()"
                            ></app-chat-bubble>
                        </div>
                    </div>
                </ng-container>
                <ng-container
                    *ngIf="
                        isUploading &&
                        isSending &&
                        selectedFile &&
                        selectedFile.length > 0
                    "
                >
                    <div
                        class="flex items-start justify-end space-x-3 animate-fade-in"
                    >
                        <ng-container *ngFor="let img of selectedFile">
                            <div
                                class="relative max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl"
                            >
                                <div class="relative w-32 h-32">
                                    <div
                                        class="absolute inset-0 flex items-center justify-center"
                                    >
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <ng-container *ngIf="isResponding">
                    <div class="flex items-start space-x-3">
                        <div
                            class="w-10 text-center bg-gray-300 rounded-md animate-pulse"
                        >
                            <div class="flex items-center justify-center h-6">
                                <span
                                    class="dot inline-block w-2 h-2 bg-gray-600 rounded-full mx-0.5 animate-bounce"
                                ></span>
                                <span
                                    class="dot inline-block w-2 h-2 bg-gray-600 rounded-full mx-0.5 animate-bounce delay-500"
                                ></span>
                                <span
                                    class="dot inline-block w-2 h-2 bg-gray-600 rounded-full mx-0.5 animate-bounce delay-1000"
                                ></span>
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
        <!-- Input Section -->
        <div
            class="flex items-center p-3 px-2 py-3 mx-2 my-3 bg-white border-t border-gray-100 rounded-lg md:p-6 md:mx-6 md:px-4 md:py-5 gap-x-2 md:gap-x-8 md:my-5"
        >
            <form
                class="flex items-stretch w-full h-12 gap-2"
                [formGroup]="form"
                (ngSubmit)="addMessage()"
            >
                <!-- Khối input bình thường -->
                <ng-container *ngIf="!isRecording">
                    <div class="relative flex gap-2">
                        <app-mic-button
                            (click)="startRecording()"
                        ></app-mic-button>

                        <button
                            (click)="TriggerInputFile()"
                            (change)="InputChangeFile($event)"
                            type="button"
                            class="w-12 h-12 aspect-square p-3 transition-colors duration-200 rounded-full bg-[#E0EAFF] text-[#3941AB] hover:bg-[#3941AB] hover:text-[#E0EAFF] hover:font-bold group"
                        >
                            <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.6957 1H2.30435C1.95841 1 1.62665 1.13742 1.38203 1.38203C1.13742 1.62665 1 1.95841 1 2.30435V19.6957C1 20.0416 1.13742 20.3734 1.38203 20.618C1.62665 20.8626 1.95841 21 2.30435 21H19.6957C20.0416 21 20.3734 20.8626 20.618 20.618C20.8626 20.3734 21 20.0416 21 19.6957V2.30435C21 1.95841 20.8626 1.62665 20.618 1.38203C20.3734 1.13742 20.0416 1 19.6957 1ZM20.1304 19.6957C20.1304 19.811 20.0846 19.9216 20.0031 20.0031C19.9216 20.0846 19.811 20.1304 19.6957 20.1304H2.30435C2.18904 20.1304 2.07845 20.0846 1.99691 20.0031C1.91537 19.9216 1.86957 19.811 1.86957 19.6957V16.4022L5.47826 12.7935C5.51778 12.7527 5.56508 12.7203 5.61736 12.6982C5.66964 12.6761 5.72584 12.6646 5.78261 12.6646C5.83938 12.6646 5.89557 12.6761 5.94785 12.6982C6.00013 12.7203 6.04744 12.7527 6.08696 12.7935L8.33696 15.0435C8.58444 15.2838 8.91586 15.4183 9.26087 15.4183C9.60587 15.4183 9.9373 15.2838 10.1848 15.0435L15.0435 10.1848C15.083 10.144 15.1303 10.1116 15.1826 10.0895C15.2349 10.0674 15.2911 10.056 15.3478 10.056C15.4046 10.056 15.4608 10.0674 15.5131 10.0895C15.5654 10.1116 15.6127 10.144 15.6522 10.1848L20.1304 14.663V19.6957ZM20.1304 13.4239L16.2717 9.56522C16.0256 9.32227 15.6937 9.18605 15.3478 9.18605C15.002 9.18605 14.6701 9.32227 14.4239 9.56522L9.56522 14.4239C9.5257 14.4647 9.4784 14.4971 9.42611 14.5192C9.37383 14.5413 9.31764 14.5527 9.26087 14.5527C9.2041 14.5527 9.1479 14.5413 9.09562 14.5192C9.04334 14.4971 8.99604 14.4647 8.95652 14.4239L6.70652 12.1739C6.58534 12.0523 6.44135 11.9558 6.28281 11.89C6.12426 11.8242 5.95428 11.7903 5.78261 11.7903C5.61094 11.7903 5.44096 11.8242 5.28241 11.89C5.12386 11.9558 4.97987 12.0523 4.8587 12.1739L1.86957 15.163V2.30435C1.86957 2.18904 1.91537 2.07845 1.99691 1.99691C2.07845 1.91537 2.18904 1.86957 2.30435 1.86957H19.6957C19.811 1.86957 19.9216 1.91537 20.0031 1.99691C20.0846 2.07845 20.1304 2.18904 20.1304 2.30435V13.4239ZM8.82609 7.08696C8.82609 7.31758 8.73447 7.53876 8.5714 7.70183C8.40832 7.86491 8.18714 7.95652 7.95652 7.95652C7.84192 7.95798 7.72819 7.93649 7.62203 7.8933C7.51587 7.85012 7.41943 7.78612 7.33839 7.70508C7.25735 7.62405 7.19336 7.5276 7.15017 7.42144C7.10699 7.31528 7.0855 7.20155 7.08696 7.08696C7.08696 6.85633 7.17857 6.63516 7.34165 6.47208C7.50472 6.30901 7.7259 6.21739 7.95652 6.21739C8.18714 6.21739 8.40832 6.30901 8.5714 6.47208C8.73447 6.63516 8.82609 6.85633 8.82609 7.08696Z" fill="currentColor" stroke="currentColor" stroke-width="0.8"/>
                            </svg>

                            <input
                                #inputFile
                                multiple
                                type="file"
                                accept="image/*"
                                formControlName="file"
                                class="hidden"
                            />
                        </button>
                    </div>

                    <div class="flex flex-col self-center flex-1 min-h-12 h-auto rounded-3xl bg-[#F0F0F0]">
                        <textarea
                            #inputText
                            (input)="autoGrow(inputText)"
                            (keydown)="onKeyDown($event)"
                            formControlName="message"
                            placeholder="{{
                                translocoService.translate(
                                    'chat.input_placeholder'
                                )
                            }}"
                            class="box-border w-full px-4 pt-4 bg-transparent outline-none resize-none max-h-26 rounded-3xl"
                            style="max-height: 200px; min-height: 40px;box-sizing: border-box;"
                        ></textarea>
                    </div>
                </ng-container>

                <!-- Khối UI Recording -->
                <ng-container *ngIf="isRecording">
                    <app-audio-wave
                        class="flex flex-1"
                        (cancel)="onCancelRecording()"
                        (send)="onStopRecording()"
                        [isRecording]="isRecording"
                        [isProcessing]="isProcessing"
                        >></app-audio-wave
                    >
                </ng-container>

                <!-- Nút gửi (luôn giữ nguyên) -->
                <button
                    type="submit"
                    class="self-center justify-end p-3 w-12 h-12 overflow-hidden text-white transition-all duration-200 transform rounded-full shadow-lg bg-gradient-to-r hover:shadow-xl hover:scale-105 bg-[#E0EAFF] group"
                >
                    <ng-container *ngIf="messageValue, else likeicon">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3.09473 0.522461C4.11134 0.618875 5.41942 1.02756 6.99512 1.8125V1.81348L16.5596 6.56934C18.6332 7.60056 19.5 8.87335 19.5 10C19.5 11.1266 18.6332 12.3994 16.5596 13.4307L6.99512 18.1865C5.41665 18.9715 4.10802 19.3811 3.09082 19.4775C2.07107 19.5742 1.41344 19.3533 1.0293 18.9707C0.645793 18.5888 0.425648 17.9367 0.523438 16.9248C0.608862 16.0411 0.934246 14.9354 1.54297 13.623L1.82129 13.0479L2.79297 11.126L2.79492 11.1211C3.14293 10.415 3.14293 9.59575 2.79492 8.88965L2.79395 8.88672L1.82129 6.95312V6.95215C1.03232 5.38537 0.621295 4.08595 0.524414 3.07617C0.427428 2.06451 0.648921 1.41151 1.0332 1.0293C1.41811 0.646521 2.07596 0.425924 3.09473 0.522461ZM7.13965 8.66699C6.40812 8.66718 5.80176 9.26581 5.80176 10C5.80176 10.7342 6.40812 11.3328 7.13965 11.333H13.1738C13.9053 11.3328 14.5117 10.7341 14.5117 10C14.5117 9.26585 13.9053 8.66725 13.1738 8.66699H7.13965Z" fill="#3941AB" stroke="#3941AB"/>
                        </svg>

                    </ng-container>
                    <ng-template #likeicon>
                        <svg width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.91083 20H5.94113V6.31579H2.91083C2.37504 6.31579 1.86119 6.53759 1.48233 6.93241C1.10347 7.32722 0.890625 7.8627 0.890625 8.42105V17.8947C0.890625 18.4531 1.10347 18.9886 1.48233 19.3834C1.86119 19.7782 2.37504 20 2.91083 20ZM21.0926 6.31579H14.0219L15.1553 2.77053C15.2564 2.45412 15.2839 2.11721 15.2356 1.78753C15.1873 1.45786 15.0646 1.14486 14.8775 0.87431C14.6904 0.603764 14.4442 0.383413 14.1594 0.231406C13.8745 0.0793993 13.5591 8.64345e-05 13.2391 0H13.0118L7.96133 5.72421V20H19.0724L23.024 10.9516L23.1128 10.5263V8.42105C23.1128 7.8627 22.9 7.32722 22.5211 6.93241C22.1423 6.53759 21.6284 6.31579 21.0926 6.31579Z" fill="#3941AB"/>
                        </svg>
                    </ng-template>

                </button>
            </form>
        </div>
    </div>
</div>
