<!-- Main -->
<div
    *transloco="let t"
    class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto"
    cdkScrollable
>
    <!-- Main -->
    <div class="flex-auto p-4 sm:px-6 sm:py-4">
        <!-- Loading Skeleton -->
        <ng-container *ngIf="loading">
            <div class="w-full h-8 bg-gray-400 mb-3"></div>
            <div
                class="grid grid-cols-1 md:grid-cols-2 gap-x-4 animate-pulse mb-6"
            >
                <div *ngFor="let i of [1, 2]">
                    <div class="flex flex-col gap-2">
                        <div class="h-6 bg-gray-200 rounded w-1/3"></div>
                        <div class="h-10 bg-gray-300 rounded"></div>
                    </div>
                    <!-- <div class="h-10 bg-gray-300 rounded"></div> -->
                </div>
            </div>
        </ng-container>

        <!-- Error -->
        <div
            *ngIf="error"
            class="text-red-600 text-lg font-medium p-4 border border-red-300 rounded bg-red-50"
        >
            {{ error }}
        </div>

        <!-- Empty -->
        <div
            *ngIf="empty"
            class="text-gray-600 text-sm font-medium border border-gray-300 rounded bg-gray-50"
        >
            Không có dữ liệu để hiển thị.
        </div>

        <div *ngIf="!loading" class="flex items-center justify-between py-2">
            <div class="text-3xl font-extrabold tracking-tight leading-tight">
                Tạo mới khách hàng cá nhân
            </div>
            <mat-form-field
                floatLabel="always"
                class="w-100 fuse-mat-dense input-none-error"
            >
                <mat-select
                    [(value)]="tableId"
                    (selectionChange)="onTemplateChange($event)"
                    placeholder="Chọn biểu mẫu"
                >
                    <mat-option
                        *ngFor="let template of dataTemplate"
                        [value]="template.id"
                    >
                        {{ template.name }}
                    </mat-option>
                </mat-select>
                <button
                    mat-icon-button
                    matSuffix
                    disableRipple
                    class="custom-icon"
                >
                    <mat-icon>expand_more</mat-icon>
                </button>
            </mat-form-field>
        </div>
        <form *ngIf="!loading && !error && !empty" [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" (keydown.enter)="$event.preventDefault()">
            <fuse-alert class="mb-2" *ngIf="showAlert" [appearance]="'outline'" [showIcon]="false" [type]="alert.type"
                [@shake]="alert.type === 'error'">
                <ul class="list-disc pl-4">
                    <li *ngFor="let code of alert.code">
                        {{ t(code) }}
                    </li>
                </ul>
            </fuse-alert>
            <div *ngFor="let section of dataForm" class="mb-4 py-2 relative">
                <!-- Section title -->
                <div
                    class="w-full bg-blue-200 mb-3 py-3 pl-2 text-lg font-semibold"
                >
                    <h3>{{ section.title }}</h3>
                </div>

                <!-- Grid layout cho inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                    <div
                        *ngFor="let field of section.fields"
                        class="flex md:flex-row items-center rounded-lg relative px-3"
                    >
                        <mat-form-field
                            *ngIf="
                                [
                                    'text',
                                    'number',
                                    'email',
                                    'password',
                                    'datetime-local'
                                ].includes(field.type)
                            "
                            floatLabel="always"
                            class="w-full fuse-mat-dense"
                        >
                            <!-- [required]="field.config?.required" -->

                            <mat-label>{{ field.label }}</mat-label>
                            <input
                                matInput
                                [type]="field.type"
                                [placeholder]="field.placeholder"
                                [formControlName]="field.name"
                                class="h-full"
                                [required]="field.config?.required"
                            />
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('required')
                                "
                            >
                                {{ field.label }} là bắt buộc
                            </mat-error>
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('maxlength')
                                "
                            >
                                {{ field.label }} vượt quá độ dài cho phép
                            </mat-error>
                            <!-- Email -->
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('email')
                                "
                            >
                                {{ field.label }} không đúng định dạng email
                            </mat-error>

                            <!-- Pattern (phone number) -->
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('pattern')
                                "
                            >
                                {{ field.label }} không đúng định dạng
                            </mat-error>
                        </mat-form-field>

                        <!-- Input dạng date -->
                        <mat-form-field
                            *ngIf="field.type === 'date'"
                            floatLabel="always"
                            class="w-full fuse-mat-dense"
                        >
                            <mat-label>{{ field.label }}</mat-label>

                            <!-- Edit mode -->
                            <input
                                matInput
                                [formControlName]="field.name"
                                placeholder="dd/mm/yyyy"
                                class="cursor-pointer"
                                (click)="picker.open()"
                                readonly
                                [matDatepicker]="picker"
                                [matDatepickerMax]="today"
                            />
                            <mat-datepicker-toggle
                                matSuffix
                                [for]="picker"
                            ></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('maxDate') &&
                                    dynamicForm.get(field.name)?.touched
                                "
                            >
                                {{ field.label }} không được lớn hơn hiện tại
                            </mat-error>
                        </mat-form-field>

                        <!-- Select dropdown -->
                        <mat-form-field
                            *ngIf="field.type === 'select'"
                            floatLabel="always"
                            class="w-full fuse-mat-dense"
                        >
                            <mat-label>{{ field.label }}</mat-label>
                            <!-- <mat-form-field>
                                <input
                                    [required]="field.config?.required"
                                    [formControlName]="field.name"
                                    [placeholder]="field.placeholder"
                                    [matAutocomplete]="auto"
                                />
                            </mat-form-field> -->

                            <!-- <mat-autocomplete
                                #auto="matAutocomplete"
                                [displayWith]="displayFn"
                            > -->
                            <mat-select
                                (selectionChange)="
                                    onChangeSelected($event.value, field.name)
                                "
                                [disabled]="field.disabled"
                                [formControlName]="field.name"
                                [placeholder]="field.placeholder"
                            >
                                <mat-option
                                    *ngFor="
                                        let option of field.select_options || []
                                    "
                                    [value]="option.id"
                                >
                                    {{ option.name }}
                                </mat-option>

                                <ng-container
                                    *ngIf="
                                        field.name === 'address_districts_name'
                                    "
                                >
                                    <mat-option
                                        *ngFor="
                                            let option of districtOptions || []
                                        "
                                        [value]="option.id"
                                    >
                                        {{ option.name }}
                                    </mat-option>
                                </ng-container>
                                <ng-container
                                    *ngIf="field.name === 'address_wards_name'"
                                >
                                    <mat-option
                                        *ngFor="let option of wardOptions || []"
                                        [value]="option.id"
                                    >
                                        {{ option.name }}
                                    </mat-option>
                                </ng-container>
                                <ng-container
                                    *ngIf="field.name === 'assigned_by'"
                                >
                                    <mat-option
                                        *ngFor="
                                            let option of AssignedByOptions ||
                                                []
                                        "
                                        [value]="option.id"
                                    >
                                        {{ option.name }}
                                    </mat-option>
                                </ng-container>
                            </mat-select>

                            <!-- </mat-autocomplete> -->
                            <button
                                type="button"
                                mat-icon-button
                                matSuffix
                                disableRipple
                                class="custom-icon"
                            >
                                <mat-icon>expand_more</mat-icon>
                            </button>
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('required')
                                "
                            >
                                {{ field.label }} là bắt buộc
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field
                            *ngIf="field.type === 'textarea'"
                            floatLabel="always"
                            class="w-full fuse-mat-dense"
                        >
                            <mat-label>{{ field.label }}</mat-label>
                            <textarea
                                matInput
                                [name]="field.name"
                                [formControlName]="field.name"
                                [placeholder]="field.placeholder"
                                [required]="field.config?.required"
                                rows="1"
                            ></textarea>
                            <mat-error
                                *ngIf="
                                    dynamicForm
                                        .get(field.name)
                                        ?.hasError('required')
                                "
                            >
                                {{ field.label }} là bắt buộc
                            </mat-error>
                        </mat-form-field>

                        <div *ngIf="field.type === 'file'" class="w-full">
                            <label class="block font-semibold text-base">
                                {{ field.label }}
                                <span
                                    *ngIf="field.config?.required"
                                    class="text-red-500"
                                    >*</span
                                >
                            </label>
                            <input
                                [type]="field.type"
                                [name]="field.name"
                                [formControlName]="field.name"
                                [placeholder]="field.placeholder"
                                [required]="field.config?.required"
                                disabled
                                readonly
                                class="block w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-100 file:text-primary-700 hover:file:bg-primary-200"
                            />
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2">
                <button
                    type="button"
                    class="w-auto border border-primary bg-white text-primary px-4 py-2 rounded font-bold text-base"
                    [disabled]="dynamicForm.disabled"
                    [routerLink]="[routerList]"
                >
                    <span> Hủy bỏ </span>
                </button>
                <button
                    type="submit"
                    class="w-auto bg-primary text-white px-4 py-2 rounded font-bold text-base"
                    [disabled]="dynamicForm.disabled"
                    (click)="onSubmit()"
                >
                    <span *ngIf="!dynamicForm.disabled"> Tạo mới </span>
                    <mat-progress-spinner
                        *ngIf="dynamicForm.disabled"
                        [diameter]="24"
                        [mode]="'indeterminate'"
                    >
                    </mat-progress-spinner>
                </button>
            </div>
        </form>
    </div>
</div>
